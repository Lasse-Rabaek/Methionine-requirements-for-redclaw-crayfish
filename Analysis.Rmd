---
title: "Data analysis"
output: html_document
date: "2025-09-12"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
---------------------------------------------------------------------------------
Data wrangling

Load packages

```{r}
library("tidyverse")
library("patchwork")
library("RColorBrewer")
```

Import raw data from xlsx files

```{r}
library(readxl)
  Raw_data<-read_excel("Raw_data.xlsx")

``` 


Calculate survival rates. Survival rate is entered as a new vector in existing data frames

```{r}
Data<-Raw_data %>%
   group_by(Rep, Tmt) %>%              # group by tank (or replicate) so each has its own baseline
  mutate(
    Survival = (Ind / first(Ind[Week == 0])) * 100
  ) %>%
  ungroup()
```


Calculate individual weight. Individual weight is entered as a new vector in existing data frames


```{r}
Data<-Data %>%
  mutate(
    W=as.numeric(W),
    Ind_W=W/Ind)
```

Calculate weight gain (WG), percentage weight gain (PWG) and specific growth rate (SGR) on an individual weight basis

```{r}
Data<-Data %>%
   group_by(Rep, Tmt) %>%              
  mutate(
    WG=(Ind_W-first(Ind_W[Week == 0]))
  ) %>%
  ungroup()

Data<-Data %>%
   group_by(Rep, Tmt) %>%              
  mutate(
    PWG=(WG/first(Ind_W[Week == 0]))*100
  ) %>%
  ungroup()

Data<-Data %>%
   group_by(Rep, Tmt) %>%              
  mutate(
    SGR=(log(Ind_W)-log(first(Ind_W[Week == 0])))/14*100
  ) %>%
  ungroup()

```

Calculate weight gain (WG) and percentage weight gain (PWG) on a tank biomass basis

```{r}
Data<-Data %>%
   group_by(Rep, Tmt) %>%              
  mutate(
    WG_TB=(W-first(W[Week == 0]))
  ) %>%
  ungroup()

Data<-Data %>%
   group_by(Rep, Tmt) %>%              
  mutate(
    PWG_TB=(WG_TB/first(W[Week == 0]))*100
  ) %>%
  ungroup()

```

Calculate mean and standard error values for survival and growth indices

```{r}
Mean_survival <- Data %>% #Calculate mean survival rate by treatment and week
  group_by(Tmt, Week) %>%
  summarise(
    Survival_SE=sd(Survival)/sqrt(3),
    Survival = mean(Survival, na.rm = TRUE),
    .groups = "drop"
  )
    
  Mean_growth <- Data %>% 
  filter(!(Week %in% c(0,1,3))) %>% #Exclude weeks not containing any growth index data
    group_by(Tmt, Week) %>%
  summarise(
    WG_mean = mean(WG, na.rm = TRUE), #Calculate growth index on an individual weight basis
    WG_SE=sd(WG,na.rm=TRUE)/sqrt(3),
    PWG_mean = mean(PWG, na.rm = TRUE),
    PWG_SE=sd(PWG,na.rm=TRUE)/sqrt(3),
    SGR_mean = mean(SGR, na.rm = TRUE),
    SGR_SE=sd(SGR,na.rm=TRUE)/sqrt(3),
    
    WG_TB_mean = mean(WG_TB, na.rm = TRUE), #Calculate growth index on a tank biomass basis
    WG_TB_SE=sd(WG_TB,na.rm=TRUE)/sqrt(3),
    PWG_TB_mean = mean(PWG_TB, na.rm = TRUE),
    PWG_TB_SE=sd(PWG_TB,na.rm=TRUE)/sqrt(3),
    .groups = "drop"
  )
```
---------------------------------------------------------------------------------
Plots

Plotting survival rates over time

```{r}

ggplot(Mean_survival, aes(x=Week, y=Survival, color=Tmt)) +  #Survival rate over time
  geom_point() +
  geom_line() +
  labs(title="Survival rate over time", 
       x="Week", 
       y="Survival Rate (%)") +
  scale_y_continuous(
    breaks=c(0,20,40,60,80,100),
    limits=c(0,100)
    )+
  theme_minimal()+
  theme(plot.title=element_text(size = 14, face = "bold",hjust=0.5))

```

```{r}

ggplot(Mean_survival, aes(x=Week, y=Survival, color=Tmt)) +  #Survival rate over time
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin=Survival-Survival_SE,
                    ymax=Survival+Survival_SE),width=0.2)+
  labs(title="Survival rate over time", 
       x="Week", 
       y="Survival Rate (%)") +
  scale_y_continuous(
    breaks=c(0,20,40,60,80,100),
    limits=c(0,100)
    )+
  theme_minimal()+
  theme(plot.title=element_text(size = 14, face = "bold",hjust=0.5))+
  facet_wrap(~Tmt)

```

Performance indices over time

```{r}
ggplot(Mean_growth,aes(x=Week,y=WG_mean,color=Tmt))+  #WG over time
  geom_point()+
  geom_line(aes(group=Tmt))+
  theme_minimal()+
  labs(title="Weight gain over time",
       x="Week",
       y="SGR (%/day)")+
  theme(plot.title=element_text(size = 16, face = "bold",hjust=0.5))+
  scale_x_continuous(
    breaks=c(2,4,6),
    limits=c(2,6)
  )

ggplot(Mean_growth,aes(x=Week,y=PWG_mean,color=Tmt))+  #PWG over time
  geom_point()+
  geom_line(aes(group=Tmt))+
  theme_minimal()+
  labs(title="Percent weight gain over time",
       x="Week",
       y="SGR (%/day)")+
  theme(plot.title=element_text(size = 16, face = "bold",hjust=0.5))+
  scale_x_continuous(
    breaks=c(2,4,6),
    limits=c(2,6)
  )


ggplot(Mean_growth,aes(x=Week,y=SGR_mean,color=Tmt))+  #SGR over time
  geom_point()+
  geom_line(aes(group=Tmt))+
  theme_minimal()+
  labs(title="Specific growth rate over time",
       x="Week",
       y="SGR (%/day)")+
  theme(plot.title=element_text(size = 16, face = "bold",hjust=0.5))+
  scale_x_continuous(
    breaks=c(2,4,6),
    limits=c(2,6)
  )

```

Performance indices by treatment on an individual weight basis

```{r}
PWG_2<-Mean_growth %>%                             #PWG at week 2
  filter(Week == 2) %>%
ggplot(aes(x=Tmt,y=PWG_mean,color=Tmt))+
  geom_point()+
  geom_errorbar(aes(ymin=PWG_mean-PWG_SE,
                    ymax=PWG_mean+PWG_SE),width=0.2)+
  labs(x=NULL,y=NULL)+ #No x or y axis titles
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank()
  )+ 
  theme_minimal()


PWG_4<-Mean_growth %>%                             #PWG at week 4
  filter(Week == 4) %>%
ggplot(aes(x=Tmt,y=PWG_mean,color=Tmt))+
  geom_point()+
  geom_errorbar(aes(ymin=PWG_mean-PWG_SE,
                    ymax=PWG_mean+PWG_SE),width=0.2)+
  labs(x=NULL,y=NULL)+ #No x or y axis titles
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank()
  )+ 
  theme_minimal()
 


SGR_2<-Mean_growth %>%                             #SGR at week 2
  filter(Week == 2) %>%
ggplot(aes(x=Tmt,y=SGR_mean,color=Tmt))+
  geom_point()+
  geom_errorbar(aes(ymin=SGR_mean-SGR_SE,
                    ymax=SGR_mean+SGR_SE),width=0.2)+
  labs(x=NULL,y=NULL)+ #No x or y axis titles
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank()
  )+
  scale_y_continuous(
    limits=c(6,9)
  )+
  theme_minimal()
  


SGR_4<-Mean_growth %>%                             #SGR at week 4
  filter(Week == 4) %>%
ggplot(aes(x=Tmt,y=SGR_mean,color=Tmt))+
  geom_point()+
  geom_errorbar(aes(ymin=SGR_mean-SGR_SE,
                    ymax=SGR_mean+SGR_SE),width=0.2)+
  labs(x=NULL,y=NULL)+ #No x or y axis titles
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank()
  )+  
  theme_minimal()
  

```

Combine using the patchwork package

```{r}

PWG_2 <- PWG_2 + theme(legend.position = "none")  #Remove legends from individual plots
PWG_4 <- PWG_4 + theme(legend.position = "none")
SGR_2 <- SGR_2 + theme(legend.position = "none")
SGR_4 <- SGR_4 + theme(legend.position = "none")


top_row <- PWG_2 + PWG_4  # Collect into rows
bottom_row <- SGR_2 + SGR_4 

library(grid)  # For text manipulation

final_plot <- (
  (PWG_2+PWG_4)/(SGR_2+SGR_4)
) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")

# Add row and column labels
col1_label <- wrap_elements(grid::textGrob("Week 2", gp = grid::gpar(fontsize = 10)))
col2_label <- wrap_elements(grid::textGrob("Week 4", gp = grid::gpar(fontsize = 10)))
row1_label <- wrap_elements(grid::textGrob("PWG (%)", rot = 90, gp = grid::gpar(fontsize = 10)))
row2_label <- wrap_elements(grid::textGrob("SGR (%/day)", rot = 90, gp = grid::gpar(fontsize = 10)))

design <- "
ABC
DEF
GHI
"

final_plot <- (
  plot_spacer()+col1_label + col2_label +
  row1_label + PWG_2 + PWG_4 +
  row2_label + SGR_2 + SGR_4
) +
  plot_layout(
    design = design,
    widths = c(0.05, 1, 1),  # manually force narrow first column
    heights = c(0.1, 1, 1),
    guides = "collect"
  ) &
  theme(
    legend.position = "bottom",
    legend.box.just = "center",
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.title.y = element_text(margin = margin(r = 10))
  )


final_plot

```

Performance indices by treatment on a tank biomass basis

```{r}
Mean_growth %>%                             #PWG at week 2
  filter(Week == 2) %>%
ggplot(aes(x=Tmt,y=PWG_TB_mean,color=Tmt))+
  geom_point()+
  geom_errorbar(aes(ymin=PWG_TB_mean-PWG_TB_SE,
                    ymax=PWG_TB_mean+PWG_TB_SE),width=0.2)+
  labs(title="Percent weight gain at week 2",
       x="Treatment",
       y="Weight gain (%)")+
  theme_minimal()+
  theme(plot.title=element_text(size = 16, face = "bold",hjust=0.5))


Mean_growth %>%                             #PWG at week 4
  filter(Week == 4) %>%
ggplot(aes(x=Tmt,y=PWG_TB_mean,color=Tmt))+
  geom_point()+
  geom_errorbar(aes(ymin=PWG_TB_mean-PWG_TB_SE,
                    ymax=PWG_TB_mean+PWG_TB_SE),width=0.2)+
  labs(title="Percent weight gain at week 4",
       x="Treatment",
       y="Weight gain (%)")+
  theme_minimal()+
  theme(plot.title=element_text(size = 16, face = "bold",hjust=0.5))
```

Plotting relationship between # of individuals and individual weight

```{r}

Data %>%
  filter(Week==2) %>%
ggplot(aes(x=Ind,y=Ind_W)) +
  geom_point() +
  geom_smooth() +
  labs(title="Individual weight by number of individuals per tank at week 2",
       x="Number of individuals (n)",
       y="Individual weight (g)") +
  theme(title=element_text(size = 14,
                           face = "bold",
                           hjust=0.5))+
  theme_minimal()

Data %>%
  filter(Week==4) %>%
ggplot(aes(x=Ind,y=Ind_W)) +
  geom_point() +
  geom_smooth() +
  labs(title="Individual weight by number of individuals per tank at week 4 ",
       x="Number of Individuals (n)",
       y="Individual weight (g)") +
  theme(title=element_text(size = 14, face = "bold",hjust=0.5))+
  theme_minimal()

```

---------------------------------------------------------------------------------

Statistical tests


ANOVA and Shapiro-Wilkes test on an individual weight basis

```{r}
library(agricolae)

Data_4<-Data %>% filter(Week==4) #ANOVA for Week 4
  
PWG_aov_4 <- aov(PWG ~ Tmt, data =Data_4)  
summary(PWG_aov_4)

shapiro.test(residuals(PWG_aov_4))
qqnorm(residuals(PWG_aov_4))
qqline(residuals(PWG_aov_4))

Data_4<-Data %>% filter(Week==4) #ANOVA SGR for Week 4
  
SGR_aov_4 <- aov(SGR ~ Tmt, data =Data_4)  
summary(SGR_aov_4)

shapiro.test(residuals(SGR_aov_4))
qqnorm(residuals(SGR_aov_4))
qqline(residuals(SGR_aov_4))
```

ANOVA and Tukey post-hoc test for percentage weight gain (PWG) on a tank biomass basis 

```{r}
PWG_TB_aov_4 <- aov(PWG_TB ~ Tmt, data =Data_4)  
summary(PWG_TB_aov_4)

shapiro.test(residuals(PWG_TB_aov_4))
qqnorm(residuals(PWG_TB_aov_4))
qqline(residuals(PWG_TB_aov_4))

```