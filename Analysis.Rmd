---
title: "Data analysis"
output: html_document
date: "2025-09-12"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
---------------------------------------------------------------------------------
Data wrangling


Load packages

```{r Load packages}
library("tidyverse")
library("patchwork")
library("RColorBrewer")
```

Import raw data from xlsx files

```{r Import}
library(readxl)
  Raw_data<-read_excel("Raw_data.xlsx")
  Weight_final<-read_excel("Weight_final.xlsx")

``` 


Calculate survival rates. Survival rate is entered as a new vector in existing data frames

```{r Calculate survival}
Data<-Raw_data %>%
   group_by(Rep, Tmt) %>%              # group by tank (or replicate) so each has its own baseline
  mutate(
    Survival = (Ind / first(Ind[Week == 0])) * 100
  ) %>%
  ungroup()

```

Convert week and treatment to factor

```{r Factor conversion}

Data<-Data %>% 
  mutate(Tmt = as.factor(Tmt),
         Week=as.factor(Week),
         W=as.numeric(W))

str(Data)

```

Calculate individual weight. Individual weight is entered as a new vector in existing data frames


```{r Calculate individual weight}
Data<-Data %>%
  mutate(
    W=as.numeric(W),
    Ind_W=W/Ind)
```

Calculate weight gain (WG), percentage weight gain (PWG) and specific growth rate (SGR) on an individual weight basis

```{r}

```

```{r Performance indices}

Growth<- Data %>%
  group_by(Rep, Tmt) %>%
  arrange(Week, .by_group = TRUE) %>%
  filter(Week %in% c("0","2","4","6")) %>% 
  mutate(
    WG = Ind_W - lag(Ind_W)               #Compared with prior weight 
  ) %>%
  ungroup()

Growth<-Growth %>%
  group_by(Rep, Tmt) %>%
  arrange(Week, .by_group = TRUE) %>%
  filter(Week %in% c("0","2","4","6")) %>% 
  mutate(
    PWG = (WG/lag(Ind_W))*100               #Compared with prior weight 
  ) %>%
  ungroup()

Growth<-Growth %>%
   group_by(Rep, Tmt) %>%
   arrange(Week, .by_group = TRUE) %>%
  filter(Week %in% c("0","2","4","6")) %>%
  mutate(
    SGR=(log(Ind_W)-log(lag(Ind_W)))/14*100
  ) %>%
  
  ungroup()

```

Calculate weight gain (WG) and percentage weight gain (PWG) on a tank biomass basis

```{r TB growth}
Growth<-Growth %>%
   group_by(Rep, Tmt) %>% 
  filter(Week %in% c("0","2","4","6")) %>%
  mutate(
    WG_TB = W - lag(W)
  ) %>%
  ungroup()

Growth<-Growth %>%
   group_by(Rep, Tmt) %>% 
  filter(Week %in% c("0","2","4","6")) %>%
  mutate(
    PWG_TB=(WG_TB/lag(W))*100
  ) %>%
  filter(Week!="0") %>% #Remove week 0 as it doesnt hold any growth parameters
  ungroup()

```

Calculate mean and standard error values for survival and growth indices

```{r Mean and SD}
Mean_survival <- Data %>% #Calculate mean survival rate by treatment and week
  group_by(Tmt, Week, Met) %>%
  summarise(
    Survival_SD=sd(Survival),
    Survival = mean(Survival, na.rm = TRUE),
    .groups = "drop"
  )
    
  Mean_growth <- Growth %>% 
    group_by(Tmt, Week, Met) %>%
  summarise(
    WG_mean = mean(WG, na.rm = TRUE), #Calculate growth index on an individual weight basis
    WG_SD=sd(WG,na.rm=TRUE),
    PWG_mean = mean(PWG, na.rm = TRUE),
    PWG_SD=sd(PWG,na.rm=TRUE),
    SGR_mean = mean(SGR, na.rm = TRUE),
    SGR_SD=sd(SGR,na.rm=TRUE),
    
    WG_TB_mean = mean(WG_TB, na.rm = TRUE), #Calculate growth index on a tank biomass basis
    WG_TB_SD=sd(WG_TB,na.rm=TRUE),
    PWG_TB_mean = mean(PWG_TB, na.rm = TRUE),
    PWG_TB_SD=sd(PWG_TB,na.rm=TRUE),
    .groups = "drop"
  )
```

Calculate coefficient of variation for week 6

```{r CV ratios}
CV_ratio<-Data %>% 
  filter(!(Week %in% c("1","3","5"))) %>%
  group_by(Tmt,Week) %>% 
  summarise(
    mean_wt = mean(W),
    sd_wt   = sd(W),
    CV      = sd(W)/mean(W),
    .groups = "drop"
  )%>%
  ungroup()
```

Calculate max-min and max-mean ratios

```{r Min-Max}
Ratios<-Weight_final %>%
  group_by(Tmt, Rep) %>%
  summarise(
    max_min_ratio = ifelse(n() > 1, max(W) / min(W), NA),
    .groups = "drop"
  )

Ratios <- Ratios %>%
  left_join(
    Data %>% 
      filter(Week==6) %>%
      select(Tmt, Rep, Survival),
    by = c("Tmt", "Rep")
  )

```

---------------------------------------------------------------------------------
Plots

Plotting survival rates over time

```{r Plot: Survival}

ggplot(Mean_survival, aes(x = as.numeric(as.character(Week)), y=Survival, color=Tmt)) +  #Survival rate over time
  geom_point() +
  geom_line() +
  labs(title="Survival rate over time", 
       x="Week", 
       y="Survival Rate (%)",
       color="Treatment") +
  scale_y_continuous(
    breaks=c(0,20,40,60,80,100),
    limits=c(0,100)
    )+
  theme_minimal()+
  theme(plot.title=element_text(size = 14, face = "bold",hjust=0.5))

```

Sub-dividing survival rates by treatment

```{r Plot: Survival tmt facet}

ggplot(Mean_survival, aes(x = as.numeric(as.character(Week)), y=Survival, color=Tmt)) +  #Survival rate over time
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin=Survival-Survival_SD,
                    ymax=Survival+Survival_SD),width=0.2)+
  labs(title="Survival rate over time", 
       x="Week", 
       y="Survival Rate (%)") +
  scale_y_continuous(
    breaks=c(0,20,40,60,80,100),
    limits=c(0,100)
    )+
  theme_minimal()+
  theme(plot.title=element_text(size = 14, face = "bold",hjust=0.5))+
  facet_wrap(~Tmt)

```

Plotting performance indices over time

```{r}
ggplot(Mean_growth,aes(x = as.numeric(as.character(Week)),y=WG_mean,color=Tmt))+  #WG over time
  geom_point()+
  geom_line(aes(group=Tmt))+
  theme_minimal()+
  labs(title="Weight gain over time",
       x="Week",
       y="SGR (%/day)")+
  theme(plot.title=element_text(size = 16, face = "bold",hjust=0.5))+
  scale_x_continuous(
    breaks=c(2,4,6),
    limits=c(2,6)+
  scale_y_continous(
    
  )
  )

ggplot(Mean_growth,aes(x = as.numeric(as.character(Week)),y=PWG_mean,color=Tmt))+  #PWG over time
  geom_point()+
  geom_line(aes(group=Tmt))+
  theme_minimal()+
  labs(title="Percent weight gain over time",
       x="Week",
       y="SGR (%/day)")+
  theme(plot.title=element_text(size = 16, face = "bold",hjust=0.5))+
  scale_x_continuous(
    breaks=c(2,4,6),
    limits=c(2,6)
  )


ggplot(Mean_growth,aes(x = as.numeric(as.character(Week)),y=SGR_mean,color=Tmt))+  #SGR over time
  geom_point()+
  geom_line(aes(group=Tmt))+
  theme_minimal()+
  labs(title="Specific growth rate over time",
       x="Week",
       y="SGR (%/day)")+
  theme(plot.title=element_text(size = 16, face = "bold",hjust=0.5))+
  scale_x_continuous(
    breaks=c(2,4,6),
    limits=c(2,6)
  )

```

Performance indices by treatment on an individual weight basis

```{r}
PWG_2<-Mean_growth %>%                             #PWG at week 2
  filter(Week == 2) %>%
ggplot(aes(x=Met,y=PWG_mean,color=Tmt))+
  geom_point()+
  geom_errorbar(aes(ymin=PWG_mean-PWG_SD,
                    ymax=PWG_mean+PWG_SD),width=0.05)+
  labs(x=NULL,y=NULL)+ #No x or y axis titles
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank()
  )+ 
  scale_y_continuous(
    limits=c(0,900))+
   theme_minimal()


PWG_4<-Mean_growth %>%                             #PWG at week 4
  filter(Week == 4) %>%
ggplot(aes(x=Met,y=PWG_mean,color=Tmt))+
  geom_point()+
  geom_errorbar(aes(ymin=PWG_mean-PWG_SD,
                    ymax=PWG_mean+PWG_SD),width=0.05)+
  labs(x=NULL,y=NULL)+ #No x or y axis titles
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank()
  )+ 
  scale_y_continuous(
    limits=c(0,900))+
    theme_minimal()

PWG_6<-Mean_growth %>%                             #PWG at week 6
  filter(Week == 6) %>%
ggplot(aes(x=Met,y=PWG_mean,color=Tmt))+
  geom_point()+
  geom_errorbar(aes(ymin=PWG_mean-PWG_SD,
                    ymax=PWG_mean+PWG_SD),width=0.05)+
  labs(x=NULL,y=NULL)+ #No x or y axis titles
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank()
  )+
   scale_y_continuous(
    limits=c(-100,900))+
    theme_minimal()
 


SGR_2<-Mean_growth %>%                             #SGR at week 2
  filter(Week == 2) %>%
ggplot(aes(x=Met,y=SGR_mean,color=Tmt))+
  geom_point()+
  geom_errorbar(aes(ymin=SGR_mean-SGR_SD,
                    ymax=SGR_mean+SGR_SD),width=0.05)+
  labs(x=NULL,y=NULL)+ #No x or y axis titles
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank()
  )+
  scale_y_continuous(
    limits=c(0,20)
  )+
   theme_minimal()
  


SGR_4<-Mean_growth %>%                             #SGR at week 4
  filter(Week == 4) %>%
ggplot(aes(x=Met,y=SGR_mean,color=Tmt))+
  geom_point()+
  geom_errorbar(aes(ymin=SGR_mean-SGR_SD,
                    ymax=SGR_mean+SGR_SD),width=0.05)+
  labs(x=NULL,y=NULL)+ #No x or y axis titles
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank()
  )+  
   scale_y_continuous(
    limits=c(0,20))+
    theme_minimal()

SGR_6<-Mean_growth %>%                             #SGR at week 6
  filter(Week == 6) %>%
ggplot(aes(x=Met,y=SGR_mean,color=Tmt))+
  geom_point()+
  geom_errorbar(aes(ymin=SGR_mean-SGR_SD,
                    ymax=SGR_mean+SGR_SD),width=0.05)+
  labs(x=NULL,y=NULL)+ #No x or y axis titles
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank()
  )+  
   scale_y_continuous(
    limits=c(0,20))+
   theme_minimal()

PWG_2

PWG_4

PWG_6

SGR_2

SGR_4

SGR_6

```

Combine using the patchwork package

```{r}

PWG_2 <- PWG_2 + theme(legend.position = "none")  #Remove legends from individual plots
PWG_4 <- PWG_4 + theme(legend.position = "none")
PWG_6 <- PWG_6 + theme(legend.position = "none")
SGR_2 <- SGR_2 + theme(legend.position = "none")
SGR_4 <- SGR_4 + theme(legend.position = "none")
SGR_6 <- SGR_6 + theme(legend.position = "none")


top_row <- PWG_2 + PWG_4 + PWG_6  # Collect into rows
bottom_row <- SGR_2 + SGR_4 + SGR_6

library(grid)  # For text manipulation

final_plot <- (
  (PWG_2+PWG_4+PWG_6)/(SGR_2+SGR_4+SGR_6)
) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")

# Add row and column labels
col1_label <- wrap_elements(grid::textGrob("Week 2", gp = grid::gpar(fontsize = 10)))
col2_label <- wrap_elements(grid::textGrob("Week 4", gp = grid::gpar(fontsize = 10)))
col3_label <- wrap_elements(grid::textGrob("Week 6", gp = grid::gpar(fontsize = 10)))
row1_label <- wrap_elements(grid::textGrob("Percent weight gain (%)", rot = 90, gp = grid::gpar(fontsize = 7)))
row2_label <- wrap_elements(grid::textGrob("Specific growth rate (%/day)", rot = 90, gp = grid::gpar(fontsize = 7)))

design <- "
ABCD
EFGH
IJKL
"

final_plot <- (
  plot_spacer()+col1_label + col2_label + col3_label +
  row1_label + PWG_2 + PWG_4 + PWG_6 +
  row2_label + SGR_2 + SGR_4 + SGR_6+
  plot_spacer()
) +
  plot_layout(
    design = design,
    widths = c(0.05, 1, 1, 1),  # manually force narrow first column
    heights = c(0.1, 1, 1),
    guides = "collect"
  ) &
  theme(
    legend.position = "bottom",
    legend.box = "horizontal",
    legend.direction = "horizontal"
  )&
  labs(color="Treatment")  # Add a common legend title
  


final_plot

```

Performance indices by treatment on a tank biomass basis

```{r}
Mean_growth %>%                             #PWG at week 2
  filter(Week == 2) %>%
ggplot(aes(x=Met,y=PWG_TB_mean,color=Tmt))+
  geom_point()+
  geom_errorbar(aes(ymin=PWG_TB_mean-PWG_TB_SE,
                    ymax=PWG_TB_mean+PWG_TB_SE),width=0.05)+
  labs(title="Percent weight gain at week 2",
       x="Treatment",
       y="Weight gain (%)")+
  theme_minimal()+
  theme(plot.title=element_text(size = 16, face = "bold",hjust=0.5))


Mean_growth %>%                             #PWG at week 4
  filter(Week == 4) %>%
ggplot(aes(x=Met,y=PWG_TB_mean,color=Tmt))+
  geom_point()+
  geom_errorbar(aes(ymin=PWG_TB_mean-PWG_TB_SE,
                    ymax=PWG_TB_mean+PWG_TB_SE),width=0.05)+
  labs(title="Percent weight gain at week 4",
       x="Treatment",
       y="Weight gain (%)")+
  theme_minimal()+
  theme(plot.title=element_text(size = 16, face = "bold",hjust=0.5))
```

Model relationship between survival and individual weight

```{r}
# Week 2
Data2 <- Data %>% filter(Week == "2")
Lm_2 <- lm(log(Ind_W) ~ Survival, data = Data2)
summary(Lm_2)
exp_lm2 <- exp(predict(Lm_2,newdata=Data2, interval="prediction", level=0.95))
pred2 <- data.frame(
  Week = 2,
  Survival = Data2$Survival,
  Predicted = exp_lm2
)

# Week 4
Data4 <- Data %>% filter(Week == "4")
Lm_4 <- lm(log(Ind_W) ~ Survival, data = Data4)
summary(Lm_4)
exp_lm4 <- exp(predict(Lm_4,newdata=Data4, interval="prediction", level=0.95))
pred4 <- data.frame(
  Week = 4,
  Survival = Data4$Survival,
  Predicted = exp_lm4
)

# Week 6
Data6 <- Data %>% filter(Week == "6")
Lm_6 <- lm(log(Ind_W) ~ Survival, data = Data6)
summary(Lm_6)
exp_lm6 <- exp(predict(Lm_6,newdata=Data6, interval="prediction", level=0.95))
pred6 <- data.frame(
  Week = 6,
  Survival = Data6$Survival,
  Predicted = exp_lm6)


```


Plotting relationship between survival and individual weight

```{r}

Data %>%
  filter(Week == "2") %>%
  ggplot(aes(x = Survival, y = Ind_W)) +
  geom_point() +
  geom_line(data = pred2, aes(x = Survival, y = Predicted.fit), inherit.aes = FALSE) +
  geom_ribbon(data = pred2, aes(x = Survival, ymin = Predicted.lwr, ymax = Predicted.upr),
              inherit.aes = FALSE, alpha = 0.2) +
  labs(title = "Individual weight by number of individuals per tank at week 2",
       x = "Survival (%)",
       y = "Individual weight (g)") +
  theme(title = element_text(size = 14, face = "bold", hjust = 0.5)) +
  theme_minimal()

Data %>%
  filter(Week=="4") %>%
ggplot(aes(x=Survival,y=Ind_W)) +
  geom_point() +
  geom_line(data = pred4, aes(x = Survival, y = Predicted.fit), inherit.aes = FALSE)+
  geom_ribbon(data = pred4, aes(x = Survival, ymin = Predicted.lwr, ymax = Predicted.upr),
              inherit.aes = FALSE, alpha = 0.2) +
  labs(title="Individual weight by number of individuals per tank at week 4 ",
       x="Survival (%)",
       y="Individual weight (g)") +
  theme(title=element_text(size = 14, face = "bold",hjust=0.5))+
  theme_minimal()

Data %>%
  filter(Week=="6") %>%
ggplot(aes(x=Survival,y=Ind_W)) +
  geom_point() +
  geom_line(data = pred6, aes(x = Survival, y = Predicted.fit), inherit.aes = FALSE)+
  geom_ribbon(data = pred6, aes(x = Survival, ymin = Predicted.lwr, ymax = Predicted.upr),
              inherit.aes = FALSE, alpha = 0.2) +
  labs(title="Individual weight by number of individuals per tank at week 6 ",
       x="Survival (%)",
       y="Individual weight (g)") +
  theme(title=element_text(size = 14, face = "bold",hjust=0.5))+
  theme_minimal()

```

Min-max ratio by survival

```{r}
Ratios %>%
  filter(!is.na(max_min_ratio))%>%
  ggplot(aes(x=Survival,y=max_min_ratio))+
  geom_point()+
  labs(x="Survival (%)",y="Max-min weight ratio")

```

CV ratios by survival

```{r}

CV_ratio %>%
  filter(!is.na(CV))%>%
  ggplot(aes(x=Survival,y=CV))+
  geom_point()

```

Plotting CV ratios

```{r Plot:CV ratios}
CV_ratio %>% 
ggplot(aes(x=Week,y=CV,color=Tmt))+
  geom_point()

```
---------------------------------------------------------------------------------

Statistical tests

Test significance using Kruskal-Wallace test on PWG and SGR
```{r KW singular}
library(rstatix)

KW_PWG<-Data %>% 
filter(!(Week %in% c(0,1,3,5))) %>% 
  group_by(Week) %>% 
  kruskal_test(PWG~Tmt) #Percent weight gain 

KW_SGR<-Data %>% 
filter(!(Week %in% c(0,1,3,5))) %>% 
  group_by(Week) %>% 
  kruskal_test(SGR~Tmt) #Specific growth rate

KW_results<-rbind(KW_PWG,KW_SGR) #Combine into results table
KW_results
```

Post-hoc Dunn test

```{r Dunn}
Dunn_PWG<-Data %>% 
filter(!(Week %in% c(0,1,3,5))) %>% #Filter out data-less weeks
  group_by(Week) %>% #Group by week 2,4 and 6
 dunn_test(PWG ~ Tmt, p.adjust.method = "bonferroni") 

Dunn_SGR<-Data %>% 
filter(!(Week %in% c(0,1,3,5))) %>% 
  group_by(Week) %>% 
 dunn_test(SGR ~ Tmt, p.adjust.method = "bonferroni")

Dunn_results<-rbind(Dunn_PWG,Dunn_SGR)
Dunn_results
```

Differences across weeks

```{r KW Week}
Data %>% 
  filter(!(Week %in% c(0,1,3,5))) %>% 
  kruskal_test(PWG~Week)

Data %>% 
  filter(!(Week %in% c(0,1,3,5))) %>% 
  kruskal_test(SGR~Week)
```


The help I recieved
```{r}
### ANOVA example
m1 <- aov(SGR~Tmt*Week, data = Data)
m2 <- aov(Ind_W ~ Tmt*Week, data = Data)

hist(sqrt(Data$SGR))
hist(Data$Ind_W)

m3 <- glm(Ind_W ~ Tmt*Survival, data = Data,
          family = Gamma()) # choose family
summary(m3)

# Deviance explained:
# (Null - Residual)/Null

(159.781  - 13.194  )/159.781  

plot(m3)

plot(m1)

summary(m1)
summary(m2)

```
